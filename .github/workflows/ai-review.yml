name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        run: |
          FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..HEAD | head -50)
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          COUNT=$(echo "$FILES" | wc -l | tr -d ' ')
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

      - name: Get diff
        id: diff
        run: |
          DIFF=$(git diff ${{ github.event.pull_request.base.sha }}..HEAD -- '*.ts' '*.tsx' '*.js' '*.jsx' '*.py' '*.sh' | head -500)
          echo "diff<<EOF" >> "$GITHUB_OUTPUT"
          echo "$DIFF" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Check design docs
        id: docs
        run: |
          MISSING=""
          # Check if implementation files changed without corresponding design docs
          for f in ${{ steps.changed.outputs.files }}; do
            case "$f" in
              src/*)
                feature=$(basename "$f" | sed 's/\..*//')
                if [ ! -f "docs/requirements/${feature}.md" ] && [ ! -f "docs/specs/${feature}.md" ]; then
                  MISSING="${MISSING}- \`${f}\` has no matching design doc\n"
                fi
                ;;
            esac
          done
          echo "missing<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$MISSING" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Post review summary
        if: steps.changed.outputs.count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = `${{ steps.changed.outputs.files }}`;
            const missingDocs = `${{ steps.docs.outputs.missing }}`;
            const fileCount = ${{ steps.changed.outputs.count }};

            let body = `## AI Review Summary\n\n`;
            body += `**${fileCount} files changed**\n\n`;

            body += `### Changed Files\n`;
            body += changedFiles.split('\n').filter(f => f).map(f => `- \`${f}\``).join('\n');
            body += '\n\n';

            if (missingDocs.trim()) {
              body += `### Missing Design Documents\n`;
              body += `The following implementation files have no matching design docs:\n\n`;
              body += missingDocs;
              body += `\n> Consider running \`/requirements <feature>\` and \`/spec <feature>\` to generate design docs.\n\n`;
            }

            body += `### Review Checklist\n`;
            body += `- [ ] Design docs exist for new features\n`;
            body += `- [ ] Tests cover acceptance criteria\n`;
            body += `- [ ] No security vulnerabilities introduced\n`;
            body += `- [ ] Error handling is appropriate\n\n`;

            body += `---\n`;
            body += `*Generated by [claude-codex-collab](https://github.com/AI-Driven-School/claude-codex-collab) AI Review*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
