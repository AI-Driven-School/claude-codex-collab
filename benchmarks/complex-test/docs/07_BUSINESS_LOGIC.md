# ビジネスロジック仕様書

## 1. ストレスチェック計算ロジック

### 1.1 57項目の構成
厚生労働省準拠のストレスチェックは以下の4つの尺度で構成されます：

- **仕事のストレス要因** (17項目): Q1-Q17
- **心身のストレス反応** (29項目): Q18-Q46
- **周囲のサポート** (9項目): Q47-Q55
- **満足度** (2項目): Q56-Q57

### 1.2 回答形式
各項目は4段階評価（1-4点）:
- **1点**: 「ほとんどなかった」「全くない」
- **2点**: 「ときどきあった」「少しある」
- **3点**: 「しばしばあった」「かなりある」
- **4点**: 「ほとんどいつもあった」「非常に多い」

### 1.3 スコア計算式

#### A. 仕事のストレス要因スコア
```
仕事の量スコア = (Q1 + Q2 + Q3 + Q4) / 4
仕事の質スコア = (Q5 + Q6 + Q7 + Q8) / 4
コントロールスコア = (Q9 + Q10 + Q11) / 3
適性スコア = (Q12 + Q13 + Q14) / 3
人間関係スコア = (Q15 + Q16 + Q17) / 3

仕事のストレス要因スコア = (仕事の量 + 仕事の質 + コントロール + 適性 + 人間関係) / 5
```

#### B. 心身のストレス反応スコア
```
活気スコア = (Q18 + Q19 + Q20 + Q21 + Q22) / 5
イライラスコア = (Q23 + Q24 + Q25 + Q26 + Q27) / 5
疲労スコア = (Q28 + Q29 + Q30 + Q31 + Q32) / 5
不安スコア = (Q33 + Q34 + Q35 + Q36 + Q37) / 5
抑うつスコア = (Q38 + Q39 + Q40 + Q41 + Q42) / 5
身体愁訴スコア = (Q43 + Q44 + Q45 + Q46) / 4

心身のストレス反応スコア = (活気 + イライラ + 疲労 + 不安 + 抑うつ + 身体愁訴) / 6
```

#### C. 周囲のサポートスコア
```
上司のサポートスコア = (Q47 + Q48 + Q49) / 3
同僚のサポートスコア = (Q50 + Q51 + Q52) / 3
家族・友人からのサポートスコア = (Q53 + Q54 + Q55) / 3

周囲のサポートスコア = (上司 + 同僚 + 家族・友人) / 3
```

#### D. 満足度スコア
```
満足度スコア = (Q56 + Q57) / 2
```

### 1.4 高ストレス者判定ロジック

以下の**いずれか**を満たす場合、高ストレス者と判定：

1. **心身のストレス反応スコアが高い** (閾値: 3.0以上)
2. **心身のストレス反応スコアが中程度** (2.0以上3.0未満) **かつ** **仕事のストレス要因スコアが高い** (3.0以上)
3. **心身のストレス反応スコアが中程度** (2.0以上3.0未満) **かつ** **周囲のサポートスコアが低い** (2.0未満)

```python
def is_high_stress(
    stress_reaction_score: float,
    job_stress_score: float,
    support_score: float
) -> bool:
    """
    高ストレス者判定ロジック
    
    Args:
        stress_reaction_score: 心身のストレス反応スコア
        job_stress_score: 仕事のストレス要因スコア
        support_score: 周囲のサポートスコア
    
    Returns:
        bool: 高ストレス者の場合True
    """
    # 条件1: ストレス反応が高い
    if stress_reaction_score >= 3.0:
        return True
    
    # 条件2: ストレス反応が中程度 かつ 仕事のストレス要因が高い
    if 2.0 <= stress_reaction_score < 3.0 and job_stress_score >= 3.0:
        return True
    
    # 条件3: ストレス反応が中程度 かつ サポートが低い
    if 2.0 <= stress_reaction_score < 3.0 and support_score < 2.0:
        return True
    
    return False
```

### 1.5 集団分析レポート生成ロジック

部署・事業場単位での集計：

1. **平均スコア計算**: 各尺度の平均値を算出
2. **高ストレス者割合**: `高ストレス者数 / 受検者数 * 100`
3. **改善提案生成**: 
   - 仕事のストレス要因スコアが高い部署 → 「業務量の見直しを推奨」
   - サポートスコアが低い部署 → 「コミュニケーション機会の創出を推奨」

## 2. AI感情分析ロジック

### 2.1 入力データ
- **テキスト**: ユーザーのチャットメッセージ（最大1000文字）
- **メタデータ**: 
  - 反応速度（前回メッセージからの経過時間、秒）
  - 絵文字の使用有無
  - メッセージ長

### 2.2 PIIクリーニング処理

以下のパターンを検出して置換：

```python
def clean_pii(text: str) -> str:
    """
    PII（個人特定情報）を除去
    
    置換対象:
    - メールアドレス: user@example.com → [EMAIL]
    - 電話番号: 090-1234-5678 → [PHONE]
    - 個人名（カタカナ・漢字）: 山田太郎 → [NAME]
    - 社員番号: EMP-12345 → [EMPLOYEE_ID]
    """
    # 実装詳細は utils/pii_filter.py を参照
    pass
```

### 2.3 感情スコア算出

OpenAI GPT-4o-miniを使用して以下のJSONを取得：

```json
{
  "sentiment": -0.5,  // -1.0 (Negative) ~ 1.0 (Positive)
  "topics": ["業務量", "睡眠不足"],
  "urgency": 3,  // 1 (Low) ~ 5 (High)
  "reply_suggestion": "お疲れ様です。無理をしすぎないようにしてくださいね。",
  "risk_flags": ["sleep_deprivation", "overwork"]
}
```

### 2.4 日次スコア集計

1日の複数回のチャットから以下を算出：

```python
def calculate_daily_score(chat_scores: list[dict]) -> dict:
    """
    日次スコアを集計
    
    Returns:
        {
            "sentiment_score": float,  # 平均感情スコア
            "fatigue_level": int,  # 1-5 (疲労度)
            "sleep_hours": float,  # 睡眠時間（推測）
            "risk_level": str  # "low" | "medium" | "high"
        }
    """
    # 実装詳細は services/analysis_service.py を参照
    pass
```

### 2.5 アラート発火条件

以下の条件で管理者にアラート通知：

1. **即時アラート**: 
   - `urgency >= 4` かつ `sentiment < -0.7`
   - `risk_flags`に`"suicidal_ideation"`が含まれる

2. **日次アラート**:
   - 過去7日間の平均`sentiment_score < -0.5`
   - 過去7日間で`risk_level == "high"`が3日以上

3. **匿名性担保**:
   - アラートには個人名を含めない
   - 部署単位での集計情報のみ表示

## 3. 認証・認可ロジック

### 3.1 ユーザーロール

- **admin**: 管理者（企業の人事担当者）
  - 全ユーザーの情報閲覧可能
  - ダッシュボードアクセス可能
  - 従業員の一括登録可能

- **employee**: 一般従業員
  - 自分のストレスチェック結果のみ閲覧可能
  - チャット機能利用可能
  - ダッシュボードは閲覧不可

- **doctor**: 産業医
  - 高ストレス者の詳細情報閲覧可能
  - 集団分析レポート閲覧可能
  - 個人情報へのアクセスは同意に基づく

### 3.2 JWTトークン発行

```python
def generate_jwt_token(user_id: UUID, role: str) -> str:
    """
    JWTトークンを発行
    
    Payload:
    {
        "sub": str(user_id),
        "role": role,
        "exp": datetime.utcnow() + timedelta(hours=24)
    }
    """
    pass
```

### 3.3 パスワード要件

- 最小8文字
- 英数字を含む（記号は任意）
- ハッシュ化: bcrypt（コストファクター12）

## 4. データ保持・匿名化ロジック

### 4.1 保持期間

- **ストレスチェック結果**: 5年間保持（法規制準拠）
- **チャットログ**: 1年間保持、その後匿名化
- **日次スコア**: 2年間保持

### 4.2 匿名化処理

保持期間経過後、以下の処理を実施：

1. **個人識別情報の削除**: メールアドレス、Slack ID等
2. **統計データへの変換**: 個人データを集計データに変換
3. **バックアップからの削除**: 匿名化後、元データは完全削除

## 5. バリデーションルール

### 5.1 ストレスチェック回答

- **必須項目**: 全57項目に回答が必要
- **回答値**: 1-4の整数のみ有効
- **重複受検防止**: 同一期間（年単位）での重複受検は不可

### 5.2 ユーザー登録

- **メールアドレス**: 形式チェック、重複チェック
- **企業登録**: 企業名は必須、業種は選択式
- **CSV一括登録**: 最大100件まで、エラー時は部分登録

### 5.3 チャットメッセージ

- **文字数制限**: 最大1000文字
- **レート制限**: 1ユーザーあたり1時間に10メッセージまで
- **不適切コンテンツ**: 暴力的・差別的表現はフィルタリング
